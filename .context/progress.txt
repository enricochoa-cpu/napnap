# Progress

**Last updated:** 2026-02-24 — Stats: Y-axis 4–6 ticks, day name above date (X-axis), CHART_MARGIN + tick offset for Napper-quality spacing; onboarding completed; ESSENTIAL-GAPS §6 (see logs/2026-02-24.md).

## Code Audit Applied (2026-02-15) [COMPLETED]

- [x] Low risk: Remove unused npm deps (three, @react-three/fiber, three-bvh-csg, @types/three)
- [x] Low risk: Remove useLocalStorage.ts (never imported)
- [x] Low risk: Remove BabyProfile.tsx (legacy; app uses ProfileSection/MyBabiesView/BabyDetailView)
- [x] Low risk: storage.ts — remove removeFromStorage(), remove unused STORAGE_KEYS (BABY_PROFILE, SLEEP_ENTRIES)
- [x] Refactor: Consolidate SharedBabyProfile — ProfileSection and MyBabiesView import from useBabyProfile
- [x] Refactor: SleepEntrySheet uses dateUtils getNextDay/getPreviousDay via formatDate; removed local helpers
- [x] Refactor: dateUtils — remove unused exports (formatDisplayDate, generateId)
- [ ] Out of scope: AlgorithmStatusCard (decision: delete or re-add status pill)
- [ ] Out of scope: Optional (Db* types, useCircadianTheme export, CSS audit, Sentry)

## Design Audit — Phase 1: Critical (2026-02-09) [COMPLETED]

- [x] #1 Hero card: replaced hardcoded `bg-white/[0.06]` with `var(--glass-bg)` / `var(--glass-border)` / `var(--shadow-md)`
- [x] #2 Hero countdown: upgraded from `text-5xl` (48px) to `.hero-countdown` (56px) across all 4 hero states
- [x] #3 Timeline river line: replaced `bg-white/10` with `bg-[var(--text-muted)]/20` (including loading skeleton)
- [x] #4 Ghost cards: replaced `bg-white/[0.04]` with `color-mix(in srgb, var(--accent) 5%, transparent)` for both predicted naps and bedtime
- [x] #5 Prediction labels: "Predicted Nap" → "Nap {n}", "Catnap" → "Short Nap"
- [x] #6 Removed redundant "My Babies" ListRow from ProfileMenu (baby card is the sole entry point)
- [x] #7 AccountSettingsView: replaced `text-red-400` / `bg-red-500/15` with `var(--danger-color)` tokens; replaced sign-out card glassmorphism with theme-aware tokens
- [x] #8 Settings subtitle: "Notifications, sign out" → "Account and sign out"

## Design Audit — Phase 2: Refinement (2026-02-09) [COMPLETED]

- [x] #9 Extracted shared `SubViewHeader` component; wired into all 5 sub-views (MyBabiesView, AccountSettingsView, FAQsView, ContactView, SupportView) — removed 5 duplicate BackIcon definitions
- [x] #10 Standardised `ListRow` in ProfileMenu with theme-aware glassmorphism; exported for reuse
- [x] #11 SupportView now imports `ListRow` from ProfileMenu — removed duplicate ListRow, ChevronRightIcon, BackIcon
- [x] #12 Replaced all remaining hardcoded `white/` glassmorphism: ProfileMenu baby card + empty state, SupportView tip card, MyBabiesView BabyProfileCard + AddBabyGhostCard + PlusIcon circle, StatusPill
- [x] #13 Replaced random encouraging messages with time-contextual function (morning/afternoon/evening/night)
- [x] #14 Removed emoji from ContactView subtitle; rewrote copy to match tone
- [x] #15 Wrapper div cleanup was already resolved in Phase 1 (single `space-y-3` wrapping both remaining rows)

## Design Audit — Phase 3: Polish (2026-02-09) [COMPLETED]

- [x] ProfileSection: Added AnimatePresence `mode="wait"` with directional spring slide transitions (stiffness: 300, damping: 30, ±60px). Forward drill-in slides right→left, back slides left→right. Replaced static `fade-in` class.
- [x] TodayView timeline: Added staggered `motion.div` entrance animations (staggerChildren: 0.06s, per-card spring: stiffness 400, damping 30, y: 12→0). All 6 card types wrapped.
- [x] TodayView section label: "Today's Timeline" → "Your Day"
- [x] Bonus: Morning Wake Up card — replaced last `bg-white/[0.06]` with `color-mix(in srgb, var(--wake-color) 6%, var(--glass-bg))`

## Full Codebase Light-Mode Sweep (2026-02-09) [COMPLETED]

Triggered by BabyEditSheet appearing as a black modal in morning/afternoon themes.
Audited all components and fixed every remaining `white/` and hardcoded hex colour.

- [x] BabyEditSheet: `bg-[#1a1c24]/95` → `var(--bg-card)`, all `white/` → theme tokens, `text-red-400` → `var(--danger-color)`
- [x] StatsView: 6 glassmorphism cards → `var(--glass-bg)` + `var(--glass-border)` + `var(--shadow-sm)`, tooltips, insight tag, date range filter, empty state
- [x] SkeletonTimelineCard: 6× `bg-white/10` → `bg-[var(--text-muted)]/15`
- [x] QuickActionSheet: drag handle `bg-white/20` → `bg-[var(--text-muted)]/25`
- [x] DayNavigator: 2× `hover:bg-white/5` → `hover:bg-[var(--text-muted)]/10`
- [x] MissingBedtimeModal: `hover:bg-white/10` → `hover:bg-[var(--text-muted)]/10`, `border-white/5` → `border-[var(--glass-border)]`
- [x] SleepEntrySheet: `hover:text-[#B07D7D]` → `hover:text-[var(--danger-color)]`
- [x] SleepEntry: `bg-[#ff7e5f]/20` + `text-[#ff7e5f]` → `var(--night-color)` tokens
- [x] TodayView: loading skeleton `bg-white/10` → `bg-[var(--text-muted)]/15`

## Baby Profile Redesign + SleepEntrySheet Polish (2026-02-09) [COMPLETED]

- [x] Task 1: Unified Interactive Baby Card — `active:brightness-[1.12]` feedback, "Tap to edit" inline for all owned babies
- [x] Task 2: Baby Management Flow Redesign — new `BabyDetailView.tsx` full-screen, routing in `ProfileSection.tsx`, `MyBabiesView` simplified (ShareAccess moved to detail view, BabyEditSheet only for add)
- [x] Task 3: Temporal Validation — `computeDurationMinutes()`, validation useMemo (block 0-duration/excessive, warn cross-midnight/long), error/warning messages, save button disabled on invalid
- [x] Task 4: SleepEntrySheet Polish — `items-start` alignment, arrow `pt-2`, delete icon full opacity, dynamic labels (duration under start, relative "ago" under end), Play/Stop/Check icons, removed standalone duration section

## DayNavigator Redesign (2026-02-10) [COMPLETED]

- [x] New props in App.tsx: `datesWithEntries` (Set) and `babyAge` (string) computed via `useMemo`, passed to DayNavigator
- [x] Date header: tappable "Today" / "February 10" + chevron, opens calendar modal. Baby age subtitle below
- [x] Week strip: 7-day Mon–Sun grid, selected day accent circle, today ring, entry dots, swipeable ±1 week (Framer Motion `drag="x"`)
- [x] Calendar modal: bottom sheet (spring, drag-to-dismiss), month navigation, full calendar grid with entry dots, "Back to today" + "Close" buttons
- [x] Bug fix: day letter colour — `text-[var(--text-on-accent)]` → `text-[var(--nap-color)]` (visible on dark bg)
- [x] Bug fix: calendar z-index — Tailwind `z-[60]` didn't override CSS `z-index: 50` on nav. Used inline `style={{ zIndex: 100 }}`
- [x] Extra `pb-28` on calendar footer to clear floating nav bar

## StatsView Enhancements (2026-02-11) [COMPLETED]

- [x] Bedtime trend area chart (mirrors Woke Up chart, `--night-color` theming, average reference line)
- [x] Daily Schedule Gantt chart (custom div-based, wake-up dots + nap bars + bedtime dots per day)
- [x] Dynamic legend based on max nap count in data

## UX Fixes (2026-02-11) [COMPLETED]

- [x] Scroll to top on tab switch (`window.scrollTo(0, 0)` in `handleViewChange`)
- [x] Freeze predicted nap/bedtime ghost cards during active nap (ref-based snapshot)
- [x] StatsView date range picker: replaced `sr-only` + `showPicker()` with transparent overlay `<input type="date">`
- [x] Avg Nap Time: fixed to per-nap average (totalNapMinutes / totalNapCount), not per-day total
- [x] KPI reorder: Total Sleep → Night Sleep → Nap Time → Naps/Day
- [x] Active nap/bedtime editing: removed WakeUpSheet routing, fixed SleepEntrySheet to only auto-end on pure Stop (no changes)

## ProfileMenu Simplification (2026-02-11) [COMPLETED]

- [x] Removed hero baby card (avatar, name, age) from ProfileMenu
- [x] Removed algorithm status card, StatusPill, SparklesIcon
- [x] Three clean Napper-style ListRows: My Babies → Settings → Support (icon left, text centre, arrow right)
- [x] Cleaned up unused prop chain: algorithmStatus removed from App → ProfileSection → ProfileMenu
- [x] Removed unused imports (extractWakeWindowsFromEntries, getSleepConfigForAge, determineCalibrationState, AlgorithmStatusCard, BabyAvatarPicker, calculateAge)

## Code Quality Audit — Phase 1: Broken Flows (2026-02-12) [COMPLETED]

- [x] Created reusable `ConfirmationModal` component (themed, replaces native `confirm()`)
- [x] Replaced all 4 native `confirm()` calls with `ConfirmationModal` (SleepEntrySheet, WakeUpSheet, BabyDetailView, BabyEditSheet)
- [x] Wired up Delete Baby functionality (prop threading through App → ProfileSection → BabyDetailView/BabyEditSheet)
- [x] Delete Account shows "Not yet available" with disabled button (properly communicated)

## Code Quality Audit — Phase 2: Accessibility (2026-02-12) [COMPLETED]

- [x] Created `useFocusTrap` hook (Tab/Shift+Tab cycling, Escape key, focus save/restore)
- [x] Added `<MotionConfig reducedMotion="user">` to App root (all Framer Motion animations respect prefers-reduced-motion)
- [x] Added CSS `@media (prefers-reduced-motion: reduce)` block (kills all CSS animations/transitions)
- [x] Added `role="dialog"` / `role="alertdialog"` + `aria-modal="true"` to all 9 modals/sheets
- [x] Added focus trap to all 9 modals/sheets
- [x] Added `aria-label` to icon-only buttons (day buttons, time inputs, calendar triggers)
- [x] Added `aria-hidden="true"` to all 7 backdrop overlays
- [x] Increased all 40px touch targets to 44px (WCAG minimum)

## Code Quality Audit — Phase 3: Light Mode Polish (2026-02-12) [COMPLETED]

- [x] Replace `border-white/10` and `hover:bg-white/5` in History dropdown (App.tsx) → `border-[var(--glass-border)]`, `hover:bg-[var(--text-muted)]/10`
- [x] Replace `text-white` on bedtime icon in QuickActionSheet → `text-[var(--text-on-accent)]`
- [x] Replace hardcoded `white` in SleepEntrySheet save button → `var(--text-on-accent)` for night type
- [x] Replace `bg-white/[0.08]` in timeline river CSS (index.css) → `color-mix(in srgb, var(--text-muted) 15%, transparent)`
- [x] Replace hardcoded `rgba(255,255,255,...)` in ghost card borders CSS → `var(--glass-border)` and `color-mix` with `--nap-color`/`--night-color`
- [x] Replace hardcoded `rgba(18,20,28,0.85)` nav bar background CSS → `var(--glass-nav-bg)` and `var(--glass-border)`

## StatsView + Bottom Sheet UX (2026-02-12) [COMPLETED]

- [x] StatsView: single date range picker — one control opens DateRangePickerSheet (calendar range selection), max 15 days
- [x] All bottom sheets: tween open/close (no bounce) — `duration: 0.25, ease: 'easeOut'`
- [x] QuickActionSheet: added drag-to-dismiss (had handle bar but no drag)
- [x] ShareAccess Edit Access sheet: added drag-to-dismiss + tween
- [x] Removed handle bar bounce animation in SleepEntrySheet and WakeUpSheet

## Code Quality Audit — Phase 4: UX Improvements (2026-02-12) [COMPLETED]

- [x] Add loading states on save operations (SleepEntrySheet, WakeUpSheet, BabyDetailView: isSaving, spinner, disabled button; App handleAddEntry/handleWakeUpConfirm async/await)
- [x] Add visual affordance to StatsView date pickers — start/end date blocks as pills with chevron-down icon and subtle border/bg so they read as tappable
- [x] Add drag-to-dismiss visual hint on bottom sheets — subtle handle bar bounce on open (scaleX + opacity spring) in SleepEntrySheet and WakeUpSheet
- [x] Fix DailySummary cloud icon colour (Nap Time block: --night-color → --nap-color, stat-value-night → stat-value-nap)
- [x] Add timeout on avatar uploads — BabyAvatarPicker: 30s Promise.race, error state, "Try again" button

## Code Quality Audit — Phase 5: Nice-to-Have (2026-02-12) [COMPLETED]

- [x] Add chart accessibility (aria-labels on Recharts containers) — StatsView: role="img" + aria-label on Pie (distribution), Bar (daily sleep), Area (trend, woke up, bedtime), Gantt (daily schedule)
- [x] Fix Gantt chart midnight edge case (endMin check in StatsView) — `event.endMin != null` → `typeof event.endMin === 'number'` so nap ending at 00:00 (endMin 0) renders
- [x] Add week strip scroll indicator — DayNavigator: left/right edge fade gradients (var(--bg-deep) to transparent) to hint swipe for more weeks
- [x] Improve form validation feedback — BabyDetailView: "Name and birthday are required" when save disabled; SleepEntrySheet: "Adjust start or end time to save" when no changes to save (later removed; duration/ago layout added instead)
- [x] SleepEntrySheet Napper-style layout — No date in header; duration below start time ("29min long"), relative date below end time (today: "Xh Y min ago", yesterday: "Yesterday", older: "Feb 10"); single-line labels (whitespace-nowrap, min-w-[7ch])

## Other Pending Items

**Implemented (for reference):**
- **Delete Baby**: Implemented. Link "Delete baby profile" at bottom of BabyDetailView (full-screen edit) and in BabyEditSheet when editing an existing baby. Uses ConfirmationModal and `onDeleteBaby` → `deleteProfile` from App.
- **Add Baby**: Implemented. MyBabiesView shows ghost card "Add your baby"; tapping it opens BabyEditSheet in create mode.

## Delete Account + Anonymization (2026-02-13) [COMPLETED]

- [x] Migration: anonymized_baby_profiles, anonymized_sleep_entries (no PII; FK from anonymized_sleep_entries to anonymized_baby_profiles)
- [x] RLS: allow authenticated INSERT on both; block SELECT/UPDATE/DELETE via separate policies (not FOR ALL — see lessons 4.1, 4.2)
- [x] Allow authenticated SELECT on anonymized_baby_profiles so INSERT with .select('id') works (PostgREST runs SELECT after insert)
- [x] useBabyProfile.deleteProfile: copy active baby + sleep entries to anonymized tables, then delete profile/sleep/Storage
- [x] Edge Function delete-account: anonymize profile + sleep_entries → auth.admin.deleteUser; verify_jwt = false (Dashboard or --no-verify-jwt), validate user inside with getUser()
- [x] useDeleteAccount: getSession, delete storage objects, invoke with Authorization: Bearer token, then try/catch signOut and always onSignedOut (403 on logout after delete is expected)
- [x] AccountSettingsView: confirm button enabled, wired to useDeleteAccount; modal copy and loading/error state
- [x] supabase/config.toml: [functions.delete-account] verify_jwt = false for CLI deploys

**Not implemented / pending:**
- [ ] **Multi-baby (2+ babies per account)**: DB not ready for 1 user + 2+ own babies. To do: (1) Add `babies` table (id, owner_id, name, date_of_birth, …); (2) profiles for user-only data; (3) sleep_entries.baby_id FK to babies; (4) baby_shares reference baby_id; (5) RLS + app (useBabyProfile, useSleepEntries, create/update/delete) aligned. Full checklist in .context/ESSENTIAL-GAPS.md Priority 3.
- [ ] Resend domain verification for production invitation emails

**Implemented (for reference):**
- **Delete Account**: Implemented (2026-02-13). Full flow: storage cleanup → delete-account Edge Function (anonymize + deleteUser) → signOut (ignore 403) → redirect. See .context/plans/delete-account-with-anonymization.md and lessons 4.1, 4.2, 5.2, 5.3.

## Onboarding (2026-02-12 / 2026-02-13) [UX/UI DONE — FIRST-LOGIN PROFILE DONE]

- [x] Entry choice (Get started / I have an account)
- [x] OnboardingFlow: Welcome → Baby name → Baby DOB → Your name → Your relationship → Account
- [x] Napper-style layout (question top, Next bottom), no scroll, safe-area padding
- [x] Circadian theme on entry/onboarding (useApplyCircadianTheme in AuthGuard)
- [x] Next button disabled until required field(s) completed per step (baby name, DOB, your name)
- [x] Persist onboarding draft on Account step (sessionStorage) so it survives sign-up/Google redirect; App applies draft and calls createProfile when authenticated user has no profile (2026-02-13)
- [ ] Optional: resume on return (refresh still loses draft — sessionStorage is tab-scoped)
- [x] "Has completed onboarding" flag (skip entry for returning users) — localStorage ONBOARDING_COMPLETED + AuthGuard default entryChoice to 'account' (2026-02-24)

## Sleep Report (2026-02-13) [COMPLETED]

- [x] reportData.ts: getReportData(), tip pool (Appendix A PRD), getBedtimeCopy, getWakeUpCopy, getPatternsCopy
- [x] SleepReportView: last 30 days only (REPORT_CAP_DAYS), Overview (warm tone, no dates), Summary table, Bedtime & wake, Patterns, What to try; icon bullets (moon, sun, pattern, check); same line height (BULLET_LIST_CLASS)
- [x] StatsView: "Generate report (last 30 days)" button; showReport state; profile prop; Back to trends
- [x] Baby age fix: calculateAge() "days" = days since last month anniversary (addMonths), not totalDays % 30 — lessons §13.1
- [x] PRD, app_flow, lessons, logs, MEMORY, progress, CLAUDE updated

## Baby weight/height timeline + Stats chips (2026-02-22) [COMPLETED]

- [x] Migration: baby_weight_logs, baby_height_logs (RLS); drop profiles.baby_weight/baby_height
- [x] Types: WeightLog, HeightLog; BabyProfile/DbProfile without weight/height
- [x] useGrowthLogs: fetch, add (upsert), update, delete; getWeightWarning/getHeightWarning
- [x] GrowthLogSheet, GrowthLogList; Baby Detail compact growth (latest + "View all (N)", expandable list)
- [x] Remove single weight/height from UI and onboarding
- [x] Stats: section chips (Summary, Naps, Night, Growth); content split by section; growth charts only in Growth (or no-sleep block)
- [x] Fix: duplicate growth block removed (charts were in every section and twice in Growth)
- [x] Fix: chip scroll-into-view so selected chip stays centered
- [x] Fix: adaptive Y-domain for weight/height charts (data-driven min/max + padding)
- [x] i18n (growth + stats chips); app_flow, lessons, MEMORY, log, progress updated
