# 2026-02-24 — Stats Y-axis, onboarding completed flag, ESSENTIAL-GAPS §6

## Summary

### Stats Y-axis (duration + growth)
- **Stats charts Y-axis:** Fixed wrong or duplicate Y-axis labels on Sleep Trends charts (Average nap, Daily Sleep, Sleep summary) and Growth (weight/height). Recharts was auto-generating ticks that, when formatted (e.g. `Math.round(value/60)}h`), produced repeated labels (e.g. 0h, 1h, 1h, 1h).
- **Duration charts:** Added `durationAxisProps()` (domain 0–max rounded to 30 min, ticks every 30 min) and `formatDurationAxis()` (0h, 30m, 1h, 1h 30m, …). All duration Y-axes now use explicit `domain`, `ticks`, and this formatter.
- **Growth charts:** Added `weightAxisTicks()` and `heightAxisTicks()` to derive readable steps from existing adaptive domain (e.g. 3, 3.5, 4 kg; 50, 55, 60 cm). Weight and height Y-axes now use explicit `ticks` in both main Growth section and no-sleep block.

### Onboarding — “Has completed onboarding” (returning users → Login)
- **storage.ts:** New key `ONBOARDING_COMPLETED`; set when profile is created after onboarding so returning users can skip Entry choice.
- **App.tsx:** On successful `createProfile()` after applying onboarding draft, call `setToStorage(STORAGE_KEYS.ONBOARDING_COMPLETED, true)`.
- **AuthGuard.tsx:** Initial `entryChoice` state: if `getFromStorage(STORAGE_KEYS.ONBOARDING_COMPLETED, false)` is true, set to `'account'` so the user sees Login directly instead of “Get started” / “I have an account”.

### ESSENTIAL-GAPS.md
- **§2 Onboarding:** Retitled to “Optional draft persistence”; “Has completed onboarding” marked done; summary updated.
- **§6 Prediction system:** New section (Catalan) with 6.1–6.6: bedtime flexibility (sleep debt), overdue nap UX, unify double nap calculation, dynamic 70/30 blending, minutes-from-midnight → Date, accumulated wake time. Quick reference table and suggested order of work updated; recommended sequence for §6 added.

### Stats charts UX (axis spacing, day name, Napper-quality)
- **Y-axis tick count:** Capped at 4–6 ticks per axis (duration: step 30min–3h by range; time-of-day: round clock ticks; growth: max 6). Avoids label clutter (lesson §7.3).
- **Day name above date:** Custom `DayDateTick` shows weekday (e.g. Wed / mié.) above date (e.g. 18/2) on all date-based X-axes. `dayName` added to rangeData, wakeUp/bedtime points, averageNapChartData, weightChartData, heightChartData; locale via `getDateFnsLocale()`.
- **Axis spacing:** `CHART_MARGIN` constant: left 24, bottom 28 (was left 10, bottom 14) so "0h" and first "Wed" don’t crowd the corner; day/date labels sit clear of the chart. DayDateTick first line +4px offset for breathing room.

## Technical notes

- StatsView.tsx: `durationAxisProps`, `formatDurationAxis`, `weightAxisTicks`, `heightAxisTicks`; `averageNapAxis`, `dailySleepAxis`, `weightTicks`, `heightTicks` useMemos; all relevant YAxis components use `domain`/`ticks`/`tickFormatter` as appropriate. `CHART_MARGIN`, `DayDateTick`, `timeOfDayAxisTicks`; weightChartData/heightChartData with dayName.
- No change to data or domain logic for weight/height; only tick generation for clearer labels.
- Onboarding completed is device-local (localStorage); clearing storage or new device shows Entry choice again.

### Prediction system — Bedtime window constraint
- **Problem:** 8‑month‑old with 2 completed naps saw "Bedtime 16:30" because age config has targetNaps = 2 and the simulation never projected a 3rd nap; last nap end 13:35 + final wake window → 16:30.
- **Solution:** (1) **simulateDay()** (dateUtils): After the main nap loop, if `bedtimeMinutes < config.bedtime.earliest` and we're at target 2–3 naps (transition ages), add one **rescue catnap** (micro-nap) so projected bedtime falls inside [earliest, latest]. (2) **calculateDynamicBedtime()**: Floor the returned Date to `config.bedtime.earliest` (same calendar day as lastNapEnd) when the computed bedtime is earlier — used when we don't add a rescue nap (e.g. 1‑nap toddler).
- **Rules:** Add rescue nap only when `napCount <= targetNaps` and `targetNaps` is 2 or 3 (not for 1‑nap or 4+ nap). Do not add for newborns (avoid 6th nap) or 1‑nap toddlers (avoid 2nd nap); for those, only floor the displayed bedtime.
- **Docs:** lessons.md §1.7, ESSENTIAL-GAPS §6 (implemented note), `.context/docs/BEDTIME_WINDOW_RESEARCH_AND_SCENARIOS.md`.

---

## Stats UI Napper-style + Daytime sleep distribution + Axis overlap fix

### Stats page header and readability
- **Centered header:** Title and subtitle now centered; `stats.subtitle` i18n added (EN: "View trends and stats on your baby's sleep patterns", ES: "Distribución…"). Uses `text-display-md` for title, `text-[var(--text-secondary)]` for subtitle.
- **Section titles:** All chart section headings (e.g. Total Sleep Distribution, Daily Sleep, Daytime sleep distribution) changed from `text-muted` to `text-primary` for easier scanning.
- **Chart axis labels:** X-axis (`DayDateTick`) and all Y-axis ticks use `fill: var(--text-secondary)` instead of `--text-muted` so axis labels are more readable. Bar charts unchanged.
- **Date range block:** Left as-is (calendar icon, date range, chevron, "Xd" badge); no Napper-style simplified row.

### Daytime sleep distribution (Naps section)
- **Donut chart:** "Distribución de sueño de día" added in Stats → Naps: nap time split by nap slot (First nap, Second nap, Third nap, …) with percentages and centre "100% Total". Uses `napDistributionData` (minutes per nap index over selected range), `getNapColor`, Recharts Pie + Cell. i18n: `stats.daytimeSleepDistribution`, `stats.napFirst/Second/Third`, `stats.napOrdinal`, `stats.total`.

### Line/area chart axis overlap fix
- **Problem:** Weight/Height over time and Woke up/Bedtime area charts had the first X-axis label (day/date) overlapping the lowest Y-axis label (kg, cm, or time) at the bottom-left corner.
- **Fix:** `CHART_MARGIN_LONG_Y` increased from `left: 72, bottom: 40` to `left: 88, bottom: 48`. Applies to all area charts that use it (Growth weight/height, Night Woke up/Bedtime, and no-sleep growth block). lessons.md §7.4 added.
