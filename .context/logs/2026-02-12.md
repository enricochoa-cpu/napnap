# 2026-02-12

## Phase 2: Accessibility (A11Y) — Complete

Full accessibility pass across the entire app. No prior a11y support existed.

### New: `useFocusTrap` Hook
- **File:** `src/hooks/useFocusTrap.ts`
- Traps Tab/Shift+Tab within a container element
- Escape key fires optional `onEscape` callback
- Saves `document.activeElement` on activate, restores on deactivate
- Uses `requestAnimationFrame` for timing (Framer Motion mid-animation safety)
- Returns a `RefObject<HTMLDivElement>` to attach to the dialog container

### Reduced Motion Support
- **App.tsx:** Wrapped root in `<MotionConfig reducedMotion="user">` — all Framer Motion animations respect `prefers-reduced-motion` automatically
- **index.css:** Added `@media (prefers-reduced-motion: reduce)` block — kills all `animation-duration`, `transition-duration`, `scroll-behavior`; cancels star, cloud, loader, spinner animations

### Dialog Semantics on All 9 Modals/Sheets

| Component | Role | aria-label / aria-labelledby |
|-----------|------|------------------------------|
| SleepEntrySheet | `dialog` | `"Edit sleep entry"` / `"Log nap"` / `"Log night sleep"` |
| WakeUpSheet | `dialog` | `"Log wake up time"` |
| QuickActionSheet | `dialog` | `"Quick actions"` |
| BabyEditSheet | `dialog` | `"Add baby"` / `"Edit baby profile"` |
| CalendarModal | `dialog` | `"Calendar"` |
| ConfirmationModal | `alertdialog` | `aria-labelledby` → title element |
| ActivityCollisionModal | `alertdialog` | `aria-labelledby` → title element |
| MissingBedtimeModal | `dialog` | `aria-labelledby` → title element |
| AccountSettingsView (2x) | `alertdialog` | `"Sign out confirmation"` / `"Delete account confirmation"` |

Each dialog received: `ref={dialogRef}` (focus trap), `role`, `aria-modal="true"`, `aria-label` or `aria-labelledby`.

### Backdrop `aria-hidden="true"`
Added to all 7 backdrop `motion.div` overlays to prevent screen readers announcing them as clickable regions.

### `aria-label` Additions
- DayNavigator week strip: 7 day buttons → `format(day, 'EEEE, MMMM d')` (e.g. "Monday, February 10")
- DayNavigator calendar cells → `format(date, 'EEEE, MMMM d, yyyy')`
- DayNavigator date header → `"Open calendar"`
- SleepEntrySheet time inputs → `"Start time"` / `"End time"`
- WakeUpSheet hour/minute inputs → `"Hours"` / `"Minutes"`
- WakeUpSheet colon separator → `aria-hidden="true"`
- SleepEntrySheet dash separator → `aria-hidden="true"`

### Touch Targets (40px → 44px WCAG minimum)
- SleepEntrySheet: Delete + Close buttons `w-10 h-10` → `w-11 h-11`
- WakeUpSheet: Delete + Close buttons `w-10 h-10` → `w-11 h-11`
- DayNavigator: Prev/Next month buttons `w-10 h-10` → `w-11 h-11`
- SubViewHeader: Back button `w-10 h-10` → `w-11 h-11`
- MissingBedtimeModal: Close button → `min-w-[44px] min-h-[44px]`

### Remaining Phases Document
- Created `REMAINING-PHASES.md` in project root with detailed plans for Phase 3 (Light Mode Polish), Phase 4 (UX Improvements), and Phase 5 (Nice-to-Have Refinements)

---

## StatsView Date Range Picker + Bottom Sheet UX (same day)

### Single Date Range Picker
- **Replaced** two separate date inputs (start + end pills with native `<input type="date">`) with one **date range picker**.
- One tappable row shows e.g. "6 Feb – 12 Feb 2026 · 7d"; tapping opens **DateRangePickerSheet** (bottom sheet).
- Inside the sheet: single calendar; first tap = start date, second tap = end date; range clamped to 15 days and to today. "Apply range" commits; Cancel or drag down closes.
- **Rationale:** User wanted one component to pick ranges, and a cleaner mobile experience (no two native pickers).

### No-Bounce Bottom Sheets
- All bottom sheets now use **tween** for enter/exit: `transition={{ duration: 0.25, ease: 'easeOut' }}`. No spring, no bounce.
- **Files:** StatsView (DateRangePickerSheet), SleepEntrySheet, WakeUpSheet, DayNavigator (CalendarModal), QuickActionSheet, BabyEditSheet, ShareAccess (Edit Access sheet).
- Removed handle bar bounce animation in SleepEntrySheet and WakeUpSheet (scale/opacity spring on the bar).

### Drag-to-Dismiss Where Handle Is Shown
- **QuickActionSheet** (+ button modal): Had handle bar but no drag. Added `drag="y"`, `dragConstraints`, `dragElastic`, `onDragEnd`, `useMotionValue`/`useTransform` for backdrop, `touch-none`, and `cursor-grab` on handle.
- **ShareAccess** (Edit Access bottom sheet): Same — added full drag-to-dismiss and tween.
- **Rule:** Any modal that shows a drag handle must support drag-to-dismiss (documented in frontend_guidelines, design_system, lessons 10.17).

---

## SleepEntrySheet: Napper-Style Layout (same day)

### Header
- **Removed** entry date from header. Header now shows only type icon (cloud/moon) and label ("Nap" / "Bedtime").

### Duration and relative date below times
- **Below start time:** Duration in "Xmin long" / "Xh Ymin long" format (or "—" when no end time). Uses `formatDurationLong` (reuses `calculateDuration` + " long" suffix).
- **Below end time:** Contextual label — **today** = "Xh Y min ago" (existing `getRelativeAgo`); **yesterday** = "Yesterday"; **older** = "Feb 10" (month + day). "Sleeping..." when editing active entry with no end; "—" when new entry with no end.
- **Helpers added:** `isYesterday(dateStr)`, `formatDurationLong(start, end)`, `getRelativeDateLabel(dateStr, endTime, now, isActiveEntry)`.

### Single-line labels (no wrap)
- Duration and "ago"/date were wrapping to two lines inside fixed `w-[7ch]`. **Fixed:** `min-w-[7ch]` + `whitespace-nowrap` so labels stay on one line; row uses `items-baseline`, dash has `shrink-0`. Removed "Adjust start or end time to save" helper text earlier same day.

---

## Onboarding flow (pre-auth)

### Implemented (UX/UI only)
- **Entry choice:** "Get started" / "I have an account" before auth (AuthGuard shows EntryChoice first).
- **OnboardingFlow:** Welcome (merged) → Baby name → Baby DOB → Your name → Your relationship → Account (SignUp/Login/ForgotPassword). Napper-style layout (question top, Next bottom), fixed viewport (no scroll), safe-area padding (`.safe-pad-top`, `.safe-pad-bottom` in index.css) so content isn’t flush with browser URL bar or nav.
- **Circadian theme** on entry/onboarding: `useApplyCircadianTheme()` called in AuthGuard so morning/afternoon/night apply before login.
- **Next button validation:** Next is disabled until the step’s required input is complete (baby name, baby DOB, your name). Baby DOB default is `''` so user must pick a date; relationship has default `mum` so Next is always enabled on that step.
- **Auth forms (SignUp/Login/ForgotPassword):** Logo + short info at top, card below, bottom spacer with safe-pad-bottom; no scroll.

### Left for later
- Persist onboarding draft (e.g. localStorage) and resume; Supabase schema + writing baby/user profile on first login; "has completed onboarding" flag.
