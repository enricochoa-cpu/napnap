# 2026-02-23 — Age fix, nap learning, bedtime debt, overdue limit, UTC storage

## Summary

- **Age calculation:** Aligned `getSleepConfigForAge()` with `calculateAge()`: fractional months now use "days since last month anniversary" instead of `totalDays % 30`, so config buckets match displayed age (lessons §13.1).
- **Morning wake-up in simulation:** `calculateAllNapWindows()` accepts optional `morningWakeUp`; TodayView passes real wake-up time so projected naps and bedtime start from the actual start of day instead of default 7:00.
- **Learned nap duration:** 70/30 blend (config + history) for nap length, mirroring wake windows. `extractNapDurationsFromEntries()`, `getLearnedNapDurationMinutes()` in dateUtils; TodayView uses learned duration for active nap, projected windows, expected wake, and bedtime anchor.
- **Dynamic bedtime and sleep debt:** `calculateDynamicBedtime()` now uses `totalDaytimeSleepMinutes`: if baby has slept noticeably less than age target (debt ≥ 30 min), final wake window is shortened by up to 20 min so bedtime is earlier (constants: `SLEEP_DEBT_THRESHOLD_MINUTES`, `BEDTIME_EARLIER_CAP_MINUTES`).
- **Overdue nap persistence:** If the first predicted nap has been overdue for more than 60 min, we no longer show "NAP NOW" for it; we skip it and anchor the rest of the day on the original predicted end to avoid minute-by-minute drift (`OVERDUE_NAP_PERSISTENCE_MINUTES` in TodayView).
- **Timezone / DST:** Persist sleep entry times in UTC (`toSupabaseTimestamp` → `parseISO(datetime).toISOString()`); keep raw ISO in client state. `extractTime()` in SleepEntrySheet uses `parseISO` + `format(..., 'HH:mm')` for local display. All duration and wake-window math uses `differenceInMinutes` (instant difference). See lessons §16.1.

## Technical notes

- dateUtils: `getSleepConfigForAge` fractional age; `getLearnedNapDurationMinutes`, `extractNapDurationsFromEntries`, `NapDurationHistory`; `calculateDynamicBedtime` sleep-debt logic; comment on DST-safe `calculateDuration`.
- useSleepEntries: UTC in/out; optimistic updates use UTC; entry `date` from `format(parseISO(start_time), 'yyyy-MM-dd')`.
- SleepEntrySheet: `extractTime` now parses ISO and formats local HH:mm.
