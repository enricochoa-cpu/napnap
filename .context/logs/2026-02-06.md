# 2026-02-06 - Invitation Emails & UI Cleanup

## Cambios Realizados

### 1. Invitation Emails via Supabase Edge Function + Resend
**Nuevo archivo:** `supabase/functions/send-invitation-email/index.ts`
- Deno Edge Function que llama a Resend REST API
- Template HTML branded: dark theme, calming, con CTA "Open NapNap"
- Sender: `NapNap <onboarding@resend.dev>` (dominio test de Resend)
- Fire-and-forget desde el frontend (no bloquea la invitación)

**Archivos modificados:**
- `src/hooks/useBabyShares.ts` — `inviteByEmail()` ahora acepta `inviterName` y `babyName`, llama al Edge Function tras INSERT exitoso
- `src/components/ShareAccess.tsx` — Nuevas props `inviterName`, `babyName`, se pasan en `handleInvite`
- `src/components/Profile/ProfileSection.tsx` — Pasa `userProfile.userName` como `inviterName` a MyBabiesView
- `src/components/Profile/MyBabiesView.tsx` — Acepta y pasa `inviterName` + `profile.name` a ShareAccess
- `src/components/BabyProfile.tsx` — Pasa `userProfile` info y `profile.name` a ShareAccess
- `.env.example` — Documentación de secrets `RESEND_API_KEY` y `APP_URL`

### 2. Re-invite tras cancelar invitación
- Al cancelar (revoke) y re-invitar, el INSERT falla con unique constraint (HTTP 409)
- Fix: detectar 409/23505/duplicate y hacer UPDATE del row existente a `pending`
- También actualiza `invited_at` para reflejar la nueva fecha

### 3. UI Cleanup: Algorithm Status Pill
- Movido StatusPill de TodayView a ProfileMenu (absolute-positioned en baby card)
- Eliminado LiveStatusPill y calibration banner duplicados de TodayView
- StatusPill más sutil: más pequeño, menos opacidad

### 4. Fix: Afternoon Clouds demasiado visibles
- `AfternoonSky` no tenía contenedor `fixed` con z-index (a diferencia de Morning/Night)
- Nubes eran `rgba(255,255,255,0.6)` con `blur(1px)` — blobs blancos visibles
- Fix: contenedor `fixed inset-0 z-[-5]`, opacidad reducida a `0.15`, blur aumentado a `8px`

### 5. Fix: Stats averages incluían hoy (día incompleto)
- Si hoy tenías 2 siestas de 3 habituales, el promedio bajaba
- Fix: excluir hoy del cálculo de promedios (flag `isToday` en `rangeData`)
- Hoy sigue apareciendo en los gráficos, pero no afecta los promedios

## Bugs Encontrados y Resueltos

| Bug | Causa | Fix |
|-----|-------|-----|
| Edge Function 401 | JWT verificación manual redundante | Eliminada — Supabase verifica a nivel infra |
| Edge Function 401 (persistente) | Deploy usaba archivos locales sin pull | `--no-verify-jwt` flag + git pull antes de deploy |
| CORS blocked | CORS headers solo en OPTIONS preflight | `corsHeaders` compartido en todas las responses |
| 409 Conflict no manejado | Supabase devuelve 409, no 23505 | Check ampliado: `23505 || 409 || includes('duplicate')` |
| Re-invite no actualizaba fecha | UPDATE solo ponía status+role | Añadido `invited_at: new Date().toISOString()` |
| Afternoon clouds blancos | Opacidad 0.6, blur 1px, sin fixed container | Opacidad 0.15, blur 8px, fixed z-[-5] |
| Stats promedios incorrectos | Hoy (incompleto) incluido en averages | Excluir `isToday` del cálculo de promedios |

## Decisiones Técnicas

- **Fire-and-forget emails**: Si el email falla, la invitación en DB sigue existiendo. No rollback.
- **No verificación JWT manual**: Supabase ya lo hace. Usar `--no-verify-jwt` si la verificación automática da problemas.
- **CORS pattern**: Usar helper `jsonResponse()` que siempre incluye CORS headers.

## Pendientes

- [ ] **Verificar dominio en Resend**: Necesario para enviar emails a destinatarios externos (no solo al owner de la cuenta Resend). Opciones: verificar dominio propio o comprar uno nuevo (ej: `napnap.app`).
- [ ] Actualizar sender de `onboarding@resend.dev` a dominio verificado cuando esté listo
- [ ] Testear flujo completo end-to-end con dominio verificado

## Deployment

```bash
# Secrets configurados en Supabase
npx supabase secrets set RESEND_API_KEY=re_xxxxx
npx supabase secrets set APP_URL=https://napnap.vercel.app/

# Deploy Edge Function
npx supabase functions deploy send-invitation-email --no-verify-jwt
```

## Commits

- `62fbb22` feat: send invitation emails via Supabase Edge Function + Resend
- `6d56e92` refactor: move algorithm status pill to ProfileMenu, remove from TodayView
- `e39ceca` fix: allow re-inviting users after cancelling their invitation
- `640dfd3` fix: update invited_at timestamp when re-inviting a user
- `71d2cf6` fix: remove redundant JWT check from Edge Function
- `57b3014` fix: handle 409 conflict code when re-inviting users
- `8659930` fix: add CORS headers to all Edge Function responses
- `414a4c8` fix: make afternoon clouds subtle and properly layered
- `e12542c` fix: exclude today from stats averages since the day is incomplete
