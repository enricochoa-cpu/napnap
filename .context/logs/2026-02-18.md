# 2026-02-18

## Bug fixes and UX improvements (plan: Bugs and UX Review)

Implemented fixes from the bugs-and-UX review plan. All changes documented in `.context/lessons.md` (sections 1.6 and 14) and referenced in MEMORY and TODAY_VIEW_PREDICTION_SYSTEM.

### 1. Overdue nap — timeline card shows original predicted time (lesson 1.6)

- **Problem:** When the first predicted nap was overdue, the hero correctly showed "NAP NOW", but the timeline ghost card showed the current time as the nap start and it kept updating every minute; the user lost the expected nap time (e.g. 13:42).
- **Fix:** In `TodayView.tsx`: when pushing the overdue prediction, set `isOverdue: true`. In the timeline card render, use **display start** = `napInfo.prediction.predictedTime` when `napInfo.isOverdue`, else `napInfo.time`; display end = display start + expected duration. The card now shows the suggested window (e.g. 13:42 — 14:27); anchor math and hero unchanged.

### 2. FAB opens add-baby on fast app open (lessons 14.1–14.4)

- **Problem:** Tapping the center + button before profile finished loading sent the user to Profile → My Babies and opened the add-baby sheet instead of the sleep action menu.
- **Root cause:** `hasAnyBaby = sharedProfiles.length > 0` is false until `fetchProfile()` completes; no `profileLoading` guard.
- **Fix (optimistic, FAB never disabled):**
  - **FAB** (`App.tsx`): Open QuickActionSheet when `profileLoading || hasAnyBaby`, else `goToAddBaby()`.
  - **handleOpenNewEntry:** If `!profileLoading && !hasAnyBaby`, close action menu, call `goToAddBaby()`, return (so choosing Nap/Bedtime after opening during load redirects to add baby when we know there is none).

### 3. History "+ Add Entry" same race (lesson 14.2)

- Show "+ Add Entry" branch when `profileLoading || hasAnyBaby`; "Add a baby to log sleep" only when `!profileLoading && !hasAnyBaby`.

### 4. TodayView "Add a baby" during load (lesson 14.3)

- Pass `hasNoBaby={!profileLoading && !hasAnyBaby}` so the add-baby empty state only shows when we know there are no babies.

### 5. Profile tab skeleton while loading (lesson 14.4)

- Pass `profileLoading` from App to ProfileSection. When true, render a lightweight skeleton (title + 3 card placeholders with `animate-pulse`) instead of the full menu to avoid empty/inconsistent state.

### Files touched

- `src/components/TodayView.tsx` — overdue prediction type and timeline card display
- `src/App.tsx` — FAB logic, handleOpenNewEntry guard, History branch, hasNoBaby prop, profileLoading to ProfileSection
- `src/components/Profile/ProfileSection.tsx` — `profileLoading` prop and loading skeleton
- `.context/lessons.md` — §1.6, §14.1–14.4
- `.context/docs/TODAY_VIEW_PREDICTION_SYSTEM.md` — overdue display note, last updated
- `.context/MEMORY.md` — overdue timeline display, FAB loading guard
