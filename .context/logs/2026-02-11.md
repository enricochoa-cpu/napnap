# 2026-02-11

## StatsView — Bedtime Chart + Daily Schedule Gantt

### Bedtime Trend Chart
- Added `bedtimeData` useMemo mirroring the existing `wakeUpData` pattern
- Finds night entries whose `startTime` falls on each day, extracts minutes-since-midnight
- Area chart with `--night-color` theming, dashed average reference line, `BedTooltip`
- Placed after the "Woke Up" chart

### Daily Schedule Gantt Chart
- Custom div-based Gantt chart (Recharts doesn't support Gantt natively)
- `scheduleData` useMemo computes per-day events: wake-up (point), naps (bars), bedtime (point)
- Layout: date labels column (w-10) + chart area (flex-1 relative) with percentage positioning
- Time axis with adaptive tick intervals (1h/2h/3h depending on range)
- Grid lines as absolute-positioned 1px divs
- Nap bars: 7px-tall rounded, percentage-based left + width. Colours: Nap 1 sage, Nap 2 periwinkle, Nap 3+ muted
- Wake-up/bedtime: 7x7px rounded squares
- Dynamic legend based on `maxNapIndex`
- Same glassmorphism card style as all other chart sections

## Navigation — Scroll to Top on Tab Switch

- Added `window.scrollTo(0, 0)` in `handleViewChange()` in App.tsx
- Fixes issue where switching tabs preserved scroll position from previous view

## TodayView — Freeze Predictions During Active Nap

### Problem
While a nap was in progress ("Napping Now"), predicted ghost cards for future naps (Nap 2, Nap 3) and bedtime kept re-rendering every minute because `now` was in the `predictedNapsWithMetadata` useMemo dependency array.

### Fix
- Added `useRef`-based snapshot system: `frozenNapIdRef`, `frozenPredictionsRef`, `frozenBedtimeRef`
- When a nap starts: capture current predictions + bedtime into refs (anchored to actual nap start time)
- While napping: JSX uses frozen refs (`displayPredictions`, `displayBedtime`) instead of live memos
- When nap ends: refs clear, predictions recalculate from actual end time
- This ensures: (1) ghost cards are stable during nap, (2) post-nap predictions use real timing

### Key Insight
The `predictedNapsWithMetadata` useMemo depends on `now` (needed for overdue detection when awake), but during an active nap `now` is never used in the calculation. The memo recomputed every minute anyway due to the dependency, creating new object references that caused unnecessary re-renders.

## Commits
- `f42fce9` feat: add bedtime chart + daily schedule Gantt to StatsView
- `30deb88` fix: scroll to top when switching between tabs
- `4af8daa` fix: freeze predicted nap/bedtime cards during active nap
