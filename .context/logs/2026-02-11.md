# 2026-02-11

## StatsView — Bedtime Chart + Daily Schedule Gantt

### Bedtime Trend Chart
- Added `bedtimeData` useMemo mirroring the existing `wakeUpData` pattern
- Finds night entries whose `startTime` falls on each day, extracts minutes-since-midnight
- Area chart with `--night-color` theming, dashed average reference line, `BedTooltip`
- Placed after the "Woke Up" chart

### Daily Schedule Gantt Chart
- Custom div-based Gantt chart (Recharts doesn't support Gantt natively)
- `scheduleData` useMemo computes per-day events: wake-up (point), naps (bars), bedtime (point)
- Layout: date labels column (w-10) + chart area (flex-1 relative) with percentage positioning
- Time axis with adaptive tick intervals (1h/2h/3h depending on range)
- Grid lines as absolute-positioned 1px divs
- Nap bars: 7px-tall rounded, percentage-based left + width. Colours: Nap 1 sage, Nap 2 periwinkle, Nap 3+ muted
- Wake-up/bedtime: 7x7px rounded squares
- Dynamic legend based on `maxNapIndex`
- Same glassmorphism card style as all other chart sections

## Navigation — Scroll to Top on Tab Switch

- Added `window.scrollTo(0, 0)` in `handleViewChange()` in App.tsx
- Fixes issue where switching tabs preserved scroll position from previous view

## TodayView — Freeze Predictions During Active Nap

### Problem
While a nap was in progress ("Napping Now"), predicted ghost cards for future naps (Nap 2, Nap 3) and bedtime kept re-rendering every minute because `now` was in the `predictedNapsWithMetadata` useMemo dependency array.

### Fix
- Added `useRef`-based snapshot system: `frozenNapIdRef`, `frozenPredictionsRef`, `frozenBedtimeRef`
- When a nap starts: capture current predictions + bedtime into refs (anchored to actual nap start time)
- While napping: JSX uses frozen refs (`displayPredictions`, `displayBedtime`) instead of live memos
- When nap ends: refs clear, predictions recalculate from actual end time
- This ensures: (1) ghost cards are stable during nap, (2) post-nap predictions use real timing

### Key Insight
The `predictedNapsWithMetadata` useMemo depends on `now` (needed for overdue detection when awake), but during an active nap `now` is never used in the calculation. The memo recomputed every minute anyway due to the dependency, creating new object references that caused unnecessary re-renders.

## StatsView — Date Picker + Avg Nap + KPI Order

### Date Range Picker Fix
- `sr-only` input + `showPicker()` API was unreliable on mobile Safari
- Replaced with transparent `<input type="date">` overlaid on the display text (`absolute inset-0 opacity-0 cursor-pointer`)
- Works consistently across browsers

### Avg Nap Time Fix
- Was: average of total daily nap minutes across days (misleading)
- Now: `totalNapMinutes / totalNapCount` across all days (true per-nap average)

### KPI Reorder
- New order: Total Sleep → Night Sleep → Nap Time → Naps/Day

## SleepEntrySheet — Active Entry Editing Fix

### Problem
Editing an active nap or bedtime (changing start time) was broken — tapping save would auto-end the sleep instead of just saving the start time change.

### Root Cause
Two issues:
1. Active night entries were routed to `WakeUpSheet` (via `handleEdit` in App.tsx), which couldn't edit start time
2. `SleepEntrySheet.handleSave` always auto-ended active entries on save, even when user just changed start time

### Fix
- Removed WakeUpSheet routing — all entries now open in SleepEntrySheet
- `handleSave`: only auto-ends when no changes made (pure Stop action): `const resolvedEndTime = (isActiveEntry && !endTime && !hasChanges) ? getCurrentTime() : endTime`
- Save icon: Check when `hasChanges`, Stop when no changes

## ProfileMenu Simplification

### Changes
- Removed hero baby card (avatar, name, age display)
- Removed algorithm status card, StatusPill component, SparklesIcon
- Replaced with three clean Napper-style ListRows: My Babies → Settings → Support
- Each row: icon left, title centre, chevron arrow right

### Prop Chain Cleanup
- Removed `algorithmStatus` prop from ProfileMenu, ProfileSection, and App.tsx
- Removed `algorithmStatus` useMemo from App.tsx
- Removed unused imports: `extractWakeWindowsFromEntries`, `getSleepConfigForAge`, `determineCalibrationState`, `AlgorithmStatusCard`, `BabyAvatarPicker`, `calculateAge`
- Net: −159 lines

## Commits
- `f42fce9` feat: add bedtime chart + daily schedule Gantt to StatsView
- `30deb88` fix: scroll to top when switching between tabs
- `4af8daa` fix: freeze predicted nap/bedtime cards during active nap
- `1610aac` fix: date picker, avg nap calculation, and KPI order in StatsView
- `37e3b36` fix: allow editing active nap/bedtime start time without ending sleep
- `de3b0c7` refactor: simplify ProfileMenu — clean list rows (My Babies, Settings, Support)
