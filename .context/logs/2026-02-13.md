# Log 2026-02-13

## Summary

Delete account with data anonymization implemented end-to-end. Anonymized tables, RLS fixes, delete-baby flow (client-side anonymize), Edge Function delete-account (verify_jwt off + getUser inside), client storage cleanup + invoke with Bearer token, and handling of signOut 403 after user deletion. Lessons and context docs updated for reuse.

**Onboarding persistence:** Draft (baby name, DOB, user name, relationship) is now saved to sessionStorage when the user reaches the Account step; after sign-up (email or Google), App applies the stored draft and calls `createProfile` so new users land with baby and user profile populated. Pushed to production.

---

## Technical changes

### Database (migrations)

- **20260213000000_anonymized_tables_for_delete_account.sql**: Created `anonymized_baby_profiles` (id, baby_date_of_birth, baby_gender, baby_weight, baby_height, anonymized_at) and `anonymized_sleep_entries` (id, anonymized_baby_id FK, start_time, end_time, type, created_at). RLS: single "Block anon and authenticated" FOR ALL WITH CHECK (false) — later caused 403 on INSERT (see migrations below).
- **20260213140000_allow_authenticated_insert_anonymized.sql**: Added "Authenticated can insert" policies for both tables.
- **20260213150000_fix_anonymized_rls_insert.sql**: Dropped "Block ... FOR ALL" policies; created separate "Block select", "Block update", "Block delete" policies so INSERT is only governed by the authenticated-insert policy. **Lesson:** FOR ALL with WITH CHECK (false) applies to INSERT too; use separate FOR SELECT/UPDATE/DELETE policies for write-only tables.
- **20260213160000_allow_authenticated_select_anonymized_baby.sql**: Dropped "Block select" on `anonymized_baby_profiles`; added "Authenticated can select anonymized_baby_profiles". **Reason:** Client uses `.insert({...}).select('id').single()`; PostgREST runs a SELECT after the INSERT to return the row — without SELECT policy that request returned 403. **Lesson:** INSERT with .select() requires SELECT policy on the table (or avoid .select and use a DB function).

### Client

- **useBabyProfile.ts**: `deleteProfile` now (1) inserts current baby into `anonymized_baby_profiles` (no name/avatar), (2) fetches user's sleep_entries and inserts into `anonymized_sleep_entries` linked to the new anonymized_baby id, (3) deletes storage objects, (4) deletes profile and related data. Depends on RLS allowing authenticated INSERT and SELECT (for .select('id')) on anonymized_baby_profiles.
- **useDeleteAccount.ts**: Gets session (and checks access_token); deletes all storage objects under `baby-avatars/{userId}/`; invokes `delete-account` with `headers: { Authorization: \`Bearer ${session.access_token}\` }`; on success, calls `signOut()` in try/catch and always calls `onSignedOut()` so redirect happens even when logout returns 403 (user already deleted). **Lesson:** signOut() after deleteUser() can 403; ignore and still run signed-out callback.
- **AccountSettingsView**: Delete account confirm button enabled; wired to `useDeleteAccount.deleteAccount`; modal copy and loading/error state.

### Edge Function

- **delete-account** (supabase/functions/delete-account/index.ts): Reads Authorization header; creates anon client with that header and calls `getUser()` to resolve user id (returns 401 if missing/invalid); uses service-role client to copy profile → anonymized_baby_profiles, sleep_entries → anonymized_sleep_entries, then `auth.admin.deleteUser(userId)`. **Deploy:** Must have verify_jwt = false (Dashboard → Edge Functions → delete-account → Enforce JWT verification OFF, or `supabase functions deploy delete-account --no-verify-jwt`). **Lesson:** 401 on invoke with valid token was gateway JWT verification rejecting; disabling verify_jwt and validating user inside the function avoids that and keeps same security.
- **supabase/config.toml**: Added `[functions.delete-account] verify_jwt = false` for CLI deploys.

### Onboarding persistence (first-login profile write)

- **storage.ts**: Added `STORAGE_KEYS.ONBOARDING_DRAFT` and helpers `getOnboardingDraftFromSession`, `setOnboardingDraftInSession`, `removeOnboardingDraftFromSession` (sessionStorage so draft is tab-scoped and available after OAuth redirect).
- **OnboardingFlow.tsx**: When `step === STEP_ACCOUNT`, persist current draft to sessionStorage in a `useEffect([step, draft])` so it’s saved before the user submits sign-up or clicks Google.
- **App.tsx**: After profile load, if user is authenticated and has no profile, read onboarding draft from sessionStorage; if valid (babyName + babyDob), call `createProfile` with mapped fields (name, dateOfBirth, gender: 'other', weight/height 0, userName, userRole from relationship); on success remove draft; use ref to avoid applying twice; on create failure reset ref so user can retry.

---

## Decisions

- **Anonymized tables RLS:** Separate block policies per command (SELECT, UPDATE, DELETE), not FOR ALL, so authenticated INSERT is allowed and not overridden by a single block policy.
- **Authenticated SELECT on anonymized_baby_profiles:** Allowed so that insert-return (`.select('id')`) works; table has no PII so acceptable.
- **delete-account verify_jwt = false:** Gateway was returning 401; function validates user via getUser() and returns 401 if no/invalid token. Same security, avoids gateway quirks.
- **signOut after delete:** Do not fail the flow on logout 403; always run onSignedOut() so UI redirects.
- **Onboarding draft:** Use sessionStorage (not localStorage) so draft is available after OAuth redirect in the same tab and doesn’t persist indefinitely; apply draft only when authenticated and profile is null to avoid overwriting existing profiles.

---

## Lessons documented (see .context/lessons.md)

- **4.1** RLS "Block FOR ALL" blocks INSERT too → use separate FOR SELECT/UPDATE/DELETE.
- **4.2** INSERT with .select('id') requires SELECT policy (PostgREST runs SELECT after insert).
- **5.2** Edge Function 401 = gateway verify_jwt; fix: pass token explicitly and/or set verify_jwt = false, validate inside with getUser().
- **5.3** signOut() 403 after deleteUser() → wrap in try/catch, always call onSignedOut().

---

## Context updates

- **lessons.md**: New §4 (RLS anonymized tables), §5 (Edge Function gotchas 5.2, 5.3); renumbered subsequent sections (6–11).
- **MEMORY.md**: useDeleteAccount hook, 2026-02-13 milestone (delete account + anonymization).
- **progress.txt**: Last updated 2026-02-13; new "Delete Account + Anonymization" completed section; Delete Account marked implemented.
- **ESSENTIAL-GAPS.md**: Priority 2 (Delete account) updated to implemented.
- **plans/delete-account-with-anonymization.md**: Status note (implemented).
- **app_flow.md**: Delete account confirmation no longer TODO.
- **MEMORY.md**, **progress.txt**, **ESSENTIAL-GAPS.md**, **lessons.md**: Onboarding persistence and first-login profile write documented; Priority 1 (persist draft + write profile on first login) marked done; new lesson §12.1 (onboarding draft not persisted).

---

## Pendings

- Onboarding: "Has completed onboarding" flag (skip Entry choice for returning users); optional resume-on-refresh (draft only in sessionStorage so refresh loses it).
- Multi-baby (schema + full flow) if required.
- Resend domain verification for production emails.
- Apply migrations 20260213150000 and 20260213160000 in production if not already applied (user may have run SQL manually or db push).
