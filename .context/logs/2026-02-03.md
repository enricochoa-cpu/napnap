# Daily Log: 2026-02-03

## Summary
Sessió de **debugging i bug fix**. Trobat i arreglat un bug crític on editar un night sleep entry (per afegir wake-up time) movia incorrectament el bedtime a un dia diferent i triggerava el modal "Missing Bedtime".

---

## Bugs Fixed

### 1. Bedtime Entry Moving to Wrong Day When Adding Wake-Up
**Files:** `App.tsx:197-200`

**Problema reportat:**
- Usuari afegeix bedtime ahir a la nit
- Avui obre l'app i toca la targeta del night sleep per afegir wake-up time
- El bedtime es mou d'ahir a avui
- Apareix el modal "Missing Bedtime for yesterday"

**Investigació:**
1. Script de reproducció creat per simular el flow exacte
2. Confirmat que el bug només passa quan s'edita via SleepEntrySheet (tocar la targeta)
3. El botó "Wake Up" del QuickActionSheet funcionava correctament

**Causa arrel:**
```typescript
// App.tsx - handleEdit() NO actualitzava selectedDate
const handleEdit = (entry: SleepEntry) => {
  setEditingEntry(entry);
  setShowEntrySheet(true);  // selectedDate manté el valor d'avui!
};
```

`SleepEntrySheet.handleSave()` utilitza `selectedDate` per calcular les dates:
- Si `selectedDate = "2025-02-03"` (avui) però l'entry és del `"2025-02-02"` (ahir)
- `bedtimeDate = selectedDate` → mou el bedtime a avui
- `endTime = getNextDay(bedtimeDate)` → wake-up queda a demà
- `hasMorningWakeUp` check falla (endTime no és avui) → modal apareix

**Solució:**
```typescript
const handleEdit = (entry: SleepEntry) => {
  setEditingEntry(entry);
  setSelectedDate(entry.date);  // ← Afegit: sincronitza selectedDate amb l'entry
  setShowEntrySheet(true);
};
```

**Verificació:**
- Script de reproducció confirma el fix
- Build passa correctament
- Test manual confirmat per l'usuari

---

## Technical Details

### Flow Correcte vs Bug

| Step | Correcte (Wake Up button) | Bug (Edit via tap) |
|------|---------------------------|-------------------|
| Entry original | `2025-02-02T20:00` | `2025-02-02T20:00` |
| selectedDate | N/A (no s'usa) | `2025-02-03` (avui) |
| Després de save | `endTime: 2025-02-03T08:00` | `startTime: 2025-02-03T20:00`, `endTime: 2025-02-04T08:00` |
| Modal apareix? | No ✓ | Sí ✗ |

### Fitxers Afectats
- `src/App.tsx`: 1 línia afegida a `handleEdit()`

---

## Notes

- El bug era subtle perquè el "Wake Up" button funcionava bé (usa `endSleep()` que només actualitza `endTime`)
- El problema només apareixia quan l'usuari tocava la targeta per editar manualment
- Importància de tenir el path alternatiu (Wake Up button) per comparar comportament correcte vs incorrecte

---

### 2. Bedtime Showing Before Predicted Naps
**Files:** `TodayView.tsx:243-260`

**Problema reportat:**
- Usuari afegeix nap a les 11:45 (activa)
- Veu predicted naps a 14:38 i 18:08 (correcte)
- Veu bedtime a 15:30 (INCORRECTE - hauria de ser després de 18:08!)

**Causa arrel:**
L'ordre de prioritat per calcular l'anchor del bedtime era incorrecte:

```typescript
// ABANS (buggy):
1. Si active nap → usa expected wake time  ← GUANYAVA, ignorava predictions!
2. Else if predicted naps → usa last predicted nap's end

// DESPRÉS (fix):
1. Si predicted naps → usa last predicted nap's end  ← Ara primer!
2. Else if active nap → usa expected wake time
```

**Solució:**
```typescript
// TodayView.tsx - canvi d'ordre de prioritat
// 1. PRIORITY: If there are predicted naps, use last predicted nap's end
if (predictedNaps.length > 0) {
  const lastPredicted = predictedNaps[predictedNaps.length - 1];
  anchorEndTime = addMinutes(lastPredicted.time, lastPredicted.expectedDuration);
}
// 2. If no predicted naps but baby is currently napping
else if (activeSleep && activeSleep.type === 'nap') {
  anchorEndTime = getExpectedWakeTime(activeSleep, profile);
}
```

**Resultat:**
| Abans | Després |
|-------|---------|
| Bedtime 15:30 (abans de nap 18:08) | Bedtime ~20:53 (després de totes les naps) |

---

## Documentation Created

### TodayView Prediction System Analysis
**File:** `.context/docs/TODAY_VIEW_PREDICTION_SYSTEM.md`

Document complet que explica:
1. **Arquitectura**: Com flueix la data entre TodayView i dateUtils
2. **Conceptes clau**: Wake windows, age-based config, short nap compensation
3. **Flow de predicció**: Pas a pas de com es calculen les prediccions
4. **Simulation engine**: Com funciona simulateDay()
5. **Test cases**: Escenaris de verificació
6. **Edge cases**: Possibles problemes futurs
7. **Quick reference**: Taula de funcions clau

**Motiu:** Aquest és un sistema crític amb bugs recurrents. Necessita documentació clara per evitar regressions.

---

## Technical Details

### Prioritat Correcta per Bedtime Anchor

```
1. predictedNaps.length > 0  → Usa última predicted nap + duration
2. activeSleep (nap)         → Usa expected wake time (només si no hi ha predictions)
3. todayNaps.length > 0      → Usa última completed nap endTime
4. Fallback                  → Usa bedtime window del config
```

### Fitxers Afectats
- `src/components/TodayView.tsx`: Canvi d'ordre de prioritat (lines 243-260)
- `.context/docs/TODAY_VIEW_PREDICTION_SYSTEM.md`: Nou document

---

## Notes

- Bug #1 i #2 són problemes diferents però ambdós afecten la mateixa pantalla (TodayView)
- El sistema de prediccions és complex amb múltiples layers (TodayView → dateUtils → simulation)
- Hem creat documentació exhaustiva per evitar futurs bugs
- Recomanació: afegir unit tests per al sistema de predicció

---

## Recurring Issues Pattern

Aquest és un patró de bugs recurrents a TodayView:
1. **Prioritat incorrecta** en càlculs amb múltiples condicions
2. **State no sincronitzat** (selectedDate, active sleep, predictions)
3. **Edge cases** no considerats (nap activa + predictions futures)

**Acció preventiva:** Document `.context/docs/TODAY_VIEW_PREDICTION_SYSTEM.md` creat per servir de referència.

---

## UI Improvements

### Predicted Naps: Show Time Range Instead of Duration
**Files:** `TodayView.tsx:582-605`

**Canvi:**
- Abans: `~14:38` + `~45m` (start time + duration)
- Després: `14:38 — 15:23` (start time — end time)

**Motiu:**
Alineat amb la filosofia "Decision Replacement": els usuaris no han de fer càlculs mentals (14:38 + 45m = ?). Mostrem directament el resultat.

**Detalls:**
- Eliminat el símbol `~` (aproximació) - massa intrusiu visualment
- Eliminat de predicted naps i bedtime per consistència
- El dashed border ja indica que són prediccions, no cal més indicadors

---

---

### 3. Bedtime Ghost Card Showing During Active Night Sleep
**Files:** `TodayView.tsx:566`

**Problema reportat:**
- Usuari afegeix bedtime a les 20:45 (bebè dormint)
- Són les 21:05
- Veu una targeta ghost "Bedtime" amb hora 21:18 (NO hauria d'aparèixer!)
- La targeta apareix entre el Night Sleep actiu i les naps completades

**Escenari complet:**
- Hora actual: 21:05
- Bedtime actiu: 20:45
- 3 naps completades: 11:45-12:18, 14:00-14:25, 17:39-18:18
- Wake up: 09:30

**Causa arrel:**
La condició de renderització del bedtime card no verificava si ja hi ha un night sleep actiu:

```typescript
// ABANS (buggy):
{expectedBedtime && isBefore(now, expectedBedtime) && (
// expectedBedtime = 18:18 (última nap) + ~3hr wake window = 21:18
// 21:05 < 21:18 = true → la targeta es renderitza encara que el bebè JA està dormint!
```

**Solució:**
```typescript
// DESPRÉS (fix):
{expectedBedtime && isBefore(now, expectedBedtime) && !(activeSleep && activeSleep.type === 'night') && (
```

**Verificació:**
- Build passa correctament
- Lògica verificada: quan `activeSleep.type === 'night'`, la targeta bedtime NO es mostra

---

## Fitxers Modificats Avui

| Fitxer | Canvi |
|--------|-------|
| `src/App.tsx:197-200` | Fix #1: Sincronitza selectedDate amb entry al editar |
| `src/components/TodayView.tsx:243-260` | Fix #2: Prioritat correcta per bedtime anchor |
| `src/components/TodayView.tsx:566` | Fix #3: Amaga bedtime card durant night sleep actiu |
| `.context/docs/TODAY_VIEW_PREDICTION_SYSTEM.md` | Actualitzat amb Fix #2 i Fix #3 |

---

*Next steps: Considerar afegir unit tests per al sistema de predicció.*

---

## Feature: Google OAuth Login

### Implementation
**Files Modified:**
- `src/hooks/useAuth.ts`: Added `signInWithGoogle()` method
- `src/components/Auth/LoginForm.tsx`: Added Google button + divider
- `src/components/Auth/SignUpForm.tsx`: Added Google button + divider
- `src/components/Auth/AuthGuard.tsx`: Pass `signInWithGoogle` to forms
- `src/components/Auth/index.ts`: Export new components

**Files Created:**
- `src/components/Auth/GoogleSignInButton.tsx`: Dark-themed button with Google's colored "G" logo
- `src/components/Auth/AuthDivider.tsx`: "or" divider component

### Design Decisions

**UI Layout:**
```
┌─────────────────────────────────┐
│  [G] Continue with Google       │  ← Primary (fastest)
├─────────────────────────────────┤
│            — or —               │
├─────────────────────────────────┤
│  Email: [____________]          │
│  Password: [_________]          │
│  [Sign In]                      │  ← Secondary (fallback)
└─────────────────────────────────┘
```

**Rationale:** Google button at TOP follows "Decision Replacement" principle - fastest path first for sleep-deprived parents at 3AM.

**Button Styling:**
- Glass-morphism style (`bg-white/10`, `border-white/20`) matching app's dark theme
- Large touch target (56px min-height)
- Google's official colored "G" logo preserved for recognition

### Configuration Required (External)

**Google Cloud Console:**
1. Create OAuth consent screen (External)
2. Create OAuth client ID (Web application)
3. Add redirect URI: `https://PROJECT_ID.supabase.co/auth/v1/callback`

**Supabase Dashboard:**
1. Authentication → Providers → Enable Google
2. Add Client ID and Client Secret
3. URL Configuration: Add `http://localhost:5173` (dev) + production URL

### Edge Case: Email/Password User Signs in with Google

**Scenario:** User registered with email@example.com via password, later clicks "Continue with Google" with same email.

**Supabase Behavior (depends on config):**
- **Automatic Linking OFF (default):** Creates two separate accounts (same email, different user IDs) - causes data isolation
- **Automatic Linking ON (recommended):** Links Google identity to existing account, preserves user ID

**Recommendation:** Enable "Automatic Linking" in Supabase Dashboard → Authentication → Settings

---

## Fitxers Modificats Avui (Updated)

| Fitxer | Canvi |
|--------|-------|
| `src/App.tsx:197-200` | Fix #1: Sincronitza selectedDate amb entry al editar |
| `src/components/TodayView.tsx:243-260` | Fix #2: Prioritat correcta per bedtime anchor |
| `src/components/TodayView.tsx:566` | Fix #3: Amaga bedtime card durant night sleep actiu |
| `src/hooks/useAuth.ts` | Feature: `signInWithGoogle()` method |
| `src/components/Auth/GoogleSignInButton.tsx` | **NEW**: Google OAuth button |
| `src/components/Auth/AuthDivider.tsx` | **NEW**: "or" divider |
| `src/components/Auth/LoginForm.tsx` | Feature: Google button integration |
| `src/components/Auth/SignUpForm.tsx` | Feature: Google button integration |
| `src/components/Auth/AuthGuard.tsx` | Feature: Pass signInWithGoogle prop |
| `src/components/Auth/index.ts` | Export new components |
| `.context/docs/TODAY_VIEW_PREDICTION_SYSTEM.md` | Actualitzat amb Fix #2 i Fix #3 |
